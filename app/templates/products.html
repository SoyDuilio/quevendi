<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - QueVend√≠ PRO</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body class="theme-darkpro">
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <button class="icon-btn" onclick="window.location.href='/home'">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="header-info">
                <div class="store-name">{{ store.commercial_name }}</div>
                <div class="store-meta">Gesti√≥n de Productos</div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="showAddProduct()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="content">
            <div class="card" style="background: rgba(14, 165, 233, 0.1); border-color: var(--accent);">
                <div style="font-size: 14px; color: var(--text); margin-bottom: 8px;">
                    <strong>Total de productos:</strong> {{ products|length }}
                </div>
                <div style="font-size: 13px; color: var(--text-light);">
                    Puedes agregar, editar o eliminar productos desde aqu√≠
                </div>
            </div>

            <!-- Lista de productos -->
            <div id="products-list">
                {% if products %}
                    {% for product in products %}
                    <div class="card" style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 4px;">
                                    {{ product.name }}
                                </div>
                                <div style="font-size: 13px; color: var(--text-light);">
                                    {% if product.category %}{{ product.category }} ‚Ä¢ {% endif %}
                                    Stock: {{ product.stock }}
                                </div>
                                {% if product.aliases %}
                                <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">
                                    Tambi√©n: {{ product.aliases|join(', ') }}
                                </div>
                                {% endif %}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--accent);">
                                    S/ {{ "%.2f"|format(product.sale_price) }}
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 8px;">
                                    <button onclick="editProduct({{ product.id }}, '{{ product.name }}', {{ product.sale_price }}, {{ product.stock }})" 
                                            style="padding: 6px 12px; font-size: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        Editar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No hay productos</div>
                        <div style="font-size: 14px;">Agrega tu primer producto usando el bot√≥n +</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- MODAL AGREGAR PRODUCTO -->
    <div id="add-product-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); max-width: 400px; width: 90%; margin: 20px; border-radius: 16px; padding: 24px; max-height: 90vh; overflow-y: auto;">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--text);">Agregar Producto</h2>
            
            <form id="add-product-form" onsubmit="submitProduct(event)">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
                        Nombre del producto *
                    </label>
                    <input type="text" name="name" required 
                           placeholder="Ej: Inca Kola 1L"
                           style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px;">
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
                        Categor√≠a
                    </label>
                    <input type="text" name="category" 
                           placeholder="Ej: Bebidas"
                           style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
                            Precio de venta *
                        </label>
                        <input type="number" name="sale_price" step="0.01" required 
                               placeholder="3.50"
                               style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
                            Stock inicial
                        </label>
                        <input type="number" name="stock" value="0" 
                               style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px;">
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
                        Nombres alternativos (separados por coma)
                    </label>
                    <input type="text" name="aliases" 
                           placeholder="inka, kola amarilla"
                           style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px;">
                    <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">
                        Ayuda al sistema a encontrar el producto por voz
                    </div>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="closeAddProduct()" 
                            style="flex: 1; padding: 12px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-weight: 600; cursor: pointer;">
                        Cancelar
                    </button>
                    <button type="submit" 
                            style="flex: 1; padding: 12px; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL EDITAR -->
    <div id="edit-product-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); max-width: 400px; width: 90%; margin: 20px; border-radius: 16px; padding: 24px;">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--text);" id="edit-title">Editar Producto</h2>
            
            <form id="edit-product-form" onsubmit="submitEdit(event)">
                <input type="hidden" id="edit-product-id">
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
                        Precio de venta
                    </label>
                    <input type="number" id="edit-price" step="0.01" required 
                           style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; color: var(--text);">
                        Stock
                    </label>
                    <input type="number" id="edit-stock" required 
                           style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px;">
                </div>

                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="closeEditProduct()" 
                            style="flex: 1; padding: 12px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-weight: 600; cursor: pointer;">
                        Cancelar
                    </button>
                    <button type="submit" 
                            style="flex: 1; padding: 12px; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showAddProduct() {
            document.getElementById('add-product-modal').style.display = 'flex';
        }

        function closeAddProduct() {
            document.getElementById('add-product-modal').style.display = 'none';
            document.getElementById('add-product-form').reset();
        }

        async function submitProduct(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/products/add', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('Producto agregado exitosamente');
                    window.location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error al agregar producto');
            }
        }

        function editProduct(id, name, price, stock) {
            document.getElementById('edit-product-id').value = id;
            document.getElementById('edit-title').textContent = 'Editar: ' + name;
            document.getElementById('edit-price').value = price;
            document.getElementById('edit-stock').value = stock;
            document.getElementById('edit-product-modal').style.display = 'flex';
        }

        function closeEditProduct() {
            document.getElementById('edit-product-modal').style.display = 'none';
        }

        async function submitEdit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-product-id').value;
            const price = document.getElementById('edit-price').value;
            const stock = document.getElementById('edit-stock').value;
            
            try {
                // Actualizar precio
                await fetch(`/products/${id}/update-price`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `sale_price=${price}`
                });
                
                // Actualizar stock
                await fetch(`/products/${id}/update-stock`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `stock=${stock}`
                });
                
                alert('Producto actualizado');
                window.location.reload();
            } catch (error) {
                alert('Error al actualizar producto');
            }
        }
    </script>
</body>
</html>